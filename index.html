<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MERIDIAN</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Helvetica Neue', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #fafafa;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Settings Modal */
        .settings-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1100;
            padding: 20px;
        }

        .settings-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .settings-modal-content {
            background: white;
            border-radius: 16px;
            width: 100%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .settings-header {
            padding: 24px;
            border-bottom: 1px solid #e1e1e1;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .settings-form {
            padding: 24px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 14px;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #e1e1e1;
            border-radius: 8px;
            font-size: 14px;
            outline: none;
            transition: all 0.2s;
        }

        .form-input:focus {
            border-color: #000;
        }

        .form-help {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }

        .settings-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            padding: 24px;
            border-top: 1px solid #e1e1e1;
        }

        .btn {
            padding: 12px 24px;
            border: 1px solid #e1e1e1;
            border-radius: 50px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #000;
            color: white;
            border-color: #000;
        }

        .btn-primary:hover {
            background: #333;
        }

        .btn-secondary {
            background: white;
            color: #666;
        }

        .btn-secondary:hover {
            background: #f5f5f5;
        }

        /* Header */
        .header {
            background: white;
            border-bottom: 1px solid #e1e1e1;
            padding: 20px 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 24px;
            font-weight: 300;
            letter-spacing: 2px;
            color: #000;
        }

        .nav-buttons {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .nav-btn {
            padding: 12px 20px;
            background: white;
            border: 1px solid #e1e1e1;
            border-radius: 50px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 400;
            transition: all 0.2s;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nav-btn svg {
            width: 20px;
            height: 20px;
            fill: currentColor;
            pointer-events: none;
        }

        .nav-btn.active {
            background: #000;
            color: white;
        }

        .nav-btn:hover:not(.active) {
            background: #f5f5f5;
        }

        .settings-btn {
            padding: 12px;
            background: white;
            border: 1px solid #e1e1e1;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .settings-btn:hover {
            background: #f5f5f5;
        }

        /* Main Content */
        .main-content {
            padding: 40px 0;
            min-height: calc(100vh - 80px);
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        /* Top Screen */
        .top-screen {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            align-items: start;
        }

        /* Calendar */
        .calendar-section {
            background: white;
            border-radius: 16px;
            border: 1px solid #e1e1e1;
            overflow: hidden;
        }

        .calendar-header {
            padding: 24px;
            border-bottom: 1px solid #e1e1e1;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .calendar-title {
            font-size: 18px;
            font-weight: 400;
            letter-spacing: 1px;
        }

        .calendar-nav {
            display: flex;
            gap: 12px;
        }

        .calendar-nav-btn {
            width: 32px;
            height: 32px;
            border: 1px solid #e1e1e1;
            background: white;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.2s;
        }

        .calendar-nav-btn:hover {
            background: #f5f5f5;
        }

        .calendar-grid {
            padding: 24px;
        }

        .calendar-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            margin-bottom: 8px;
        }

        .calendar-day-header {
            padding: 8px;
            text-align: center;
            font-size: 12px;
            font-weight: 400;
            color: #666;
            letter-spacing: 0.5px;
        }

        .calendar-dates {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
        }

        .calendar-date {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s;
            position: relative;
            border: 1px solid transparent;
        }

        .calendar-date:hover {
            background: #f5f5f5;
        }

        .calendar-date.today {
            background: #000;
            color: white;
            font-weight: 500;
        }

        .calendar-date.completed {
            position: relative;
        }

        .calendar-date.completed::after {
            content: '✓';
            position: absolute;
            top: 2px;
            right: 2px;
            color: #22c55e;
            font-size: 10px;
            font-weight: bold;
        }

        .calendar-date.other-month {
            color: #ccc;
        }

        /* Today Section */
        .today-section {
            background: white;
            border-radius: 16px;
            border: 1px solid #e1e1e1;
            overflow: hidden;
        }

        .today-header {
            padding: 24px;
            border-bottom: 1px solid #e1e1e1;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .today-header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .copy-all-section {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
        }

        .copy-all-label {
            font-size: 12px;
            color: #666;
            font-weight: 400;
        }

        .copy-all-btn {
            padding: 8px 16px;
            background: #f8f8f8;
            color: #444;
            border: 1px solid #e1e1e1;
            border-radius: 50px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 400;
            transition: all 0.2s;
            letter-spacing: 0.3px;
        }

        .copy-all-btn:hover {
            background: #e1e1e1;
            color: #000;
        }

        .copy-all-btn:active {
            transform: scale(0.95);
        }

        .clear-all-btn {
            padding: 8px 16px;
            background: #fef2f2;
            color: #b91c1c;
            border: 1px solid #fecaca;
            border-radius: 50px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 400;
            transition: all 0.2s;
            letter-spacing: 0.3px;
        }

        .clear-all-btn:hover {
            background: #fee2e2;
            color: #991b1b;
        }

        .clear-all-btn:active {
            transform: scale(0.95);
        }

        .paste-btn {
            padding: 8px 16px;
            background: #f0f8ff;
            color: #0066cc;
            border: 1px solid #cce6ff;
            border-radius: 50px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 400;
            transition: all 0.2s;
            letter-spacing: 0.3px;
        }

        .paste-btn:hover {
            background: #e6f3ff;
            color: #0052a3;
        }

        .paste-btn:active {
            transform: scale(0.95);
        }

        .paste-btn:disabled {
            background: #f5f5f5;
            color: #ccc;
            cursor: not-allowed;
            border-color: #e1e1e1;
        }

        .today-title {
            font-size: 18px;
            font-weight: 400;
            letter-spacing: 1px;
        }

        .today-date {
            font-size: 14px;
            color: #666;
            letter-spacing: 0.5px;
        }

        .task-list {
            padding: 24px;
            max-height: 400px;
            overflow-y: auto;
        }

        .task-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid #f5f5f5;
        }

        .task-item:last-child {
            border-bottom: none;
        }

        .task-checkbox {
            width: 18px;
            height: 18px;
            border: 1px solid #ccc;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .task-checkbox.checked {
            background: #000;
            border-color: #000;
            color: white;
        }

        .task-text {
            flex: 1;
            font-size: 14px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .task-text.completed {
            text-decoration: line-through;
            color: #666;
        }

        .task-text:hover {
            background: #f5f5f5;
        }

        .task-text.editing {
            background: #f5f5f5;
            outline: 1px solid #ccc;
        }

        .task-actions {
            display: flex;
            gap: 8px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .task-item:hover .task-actions {
            opacity: 1;
        }

        .delete-btn {
            padding: 6px 12px;
            background: #fee;
            color: #e11d48;
            border: 1px solid #fecaca;
            border-radius: 50px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 300;
            transition: all 0.2s;
        }

        .delete-btn:hover {
            background: #fca5a5;
        }

        .copy-btn {
            padding: 6px 12px;
            background: #f5f5f5;
            color: #666;
            border: 1px solid #e1e1e1;
            border-radius: 50px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 300;
            transition: all 0.2s;
        }

        .copy-btn:hover {
            background: #e1e1e1;
        }

        .add-task {
            padding: 24px;
            border-top: 1px solid #e1e1e1;
        }

        .add-task-form {
            display: flex;
            gap: 12px;
        }

        .add-task-input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #e1e1e1;
            border-radius: 10px;
            font-size: 14px;
            outline: none;
            transition: all 0.2s;
        }

        .add-task-input:focus {
            border-color: #000;
        }

        .add-task-btn {
            padding: 12px 24px;
            background: #000;
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 400;
            transition: all 0.2s;
            letter-spacing: 0.5px;
        }

        .add-task-btn:hover {
            background: #333;
        }

        /* List Screen */
        .list-screen {
            max-width: 800px;
            margin: 0 auto;
        }

        .list-item {
            background: white;
            border-radius: 16px;
            border: 1px solid #e1e1e1;
            margin-bottom: 24px;
            overflow: hidden;
        }

        .list-item-header {
            padding: 20px 24px;
            border-bottom: 1px solid #e1e1e1;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
        }

        .list-item-header:hover {
            background: #f9f9f9;
        }

        .list-item-title {
            font-size: 16px;
            font-weight: 400;
            letter-spacing: 0.5px;
        }

        .list-item-indicator {
            width: 12px;
            height: 12px;
            border: 1px solid #ccc;
            border-radius: 50%;
            transition: all 0.2s;
        }

        .list-item.expanded .list-item-indicator {
            background: #000;
        }

        .list-item-content {
            display: none;
            padding: 24px;
        }

        .list-item.expanded .list-item-content {
            display: block;
        }

        /* Mobile Calendar Modal */
        .calendar-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            padding: 20px;
        }

        .calendar-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .calendar-modal-content {
            background: white;
            border-radius: 16px;
            width: 100%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .calendar-modal-header {
            padding: 20px;
            border-bottom: 1px solid #e1e1e1;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .close-modal {
            background: #f5f5f5;
            border: 1px solid #e1e1e1;
            border-radius: 50%;
            font-size: 18px;
            cursor: pointer;
            padding: 8px;
            line-height: 1;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .close-modal:hover {
            background: #e1e1e1;
        }

        /* Sync Status */
        .sync-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            border: 1px solid #e1e1e1;
            border-radius: 12px;
            padding: 12px 16px;
            font-size: 12px;
            color: #666;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .sync-status.saving {
            border-color: #fbbf24;
            background: #fffbeb;
            color: #92400e;
        }

        .sync-status.saved {
            border-color: #22c55e;
            background: #f0fdf4;
            color: #166534;
        }

        .sync-status.error {
            border-color: #e11d48;
            background: #fef2f2;
            color: #9f1239;
        }

        .sync-status.syncing {
            border-color: #3b82f6;
            background: #eff6ff;
            color: #1e40af;
        }

        .sync-status.local {
            border-color: #6b7280;
            background: #f9fafb;
            color: #374151;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 0 16px;
            }

            .header-content {
                flex-direction: column;
                gap: 16px;
            }

            .logo {
                font-size: 20px;
            }

            .top-screen {
                grid-template-columns: 1fr;
                gap: 24px;
            }

            .calendar-section {
                display: none;
            }

            .today-header {
                padding: 20px;
                flex-direction: column;
                gap: 12px;
            }

            .today-header-top {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            .copy-all-section {
                align-self: flex-end;
            }

            .copy-all-btn {
                font-size: 11px;
                padding: 6px 12px;
            }

            .paste-btn {
                font-size: 10px;
                padding: 5px 10px;
            }

            .today-title {
                font-size: 16px;
            }

            .mobile-date-trigger {
                display: flex;
                align-items: center;
                gap: 8px;
                cursor: pointer;
                padding: 8px 16px;
                border: 1px solid #e1e1e1;
                border-radius: 50px;
                background: white;
                transition: all 0.2s;
            }

            .mobile-date-trigger:hover {
                background: #f5f5f5;
            }

            .task-list {
                padding: 16px;
                max-height: 300px;
            }

            .add-task {
                padding: 16px;
            }

            .add-task-form {
                flex-direction: column;
            }

            .nav-btn {
                padding: 10px 20px;
                font-size: 13px;
            }

            .sync-status {
                bottom: 10px;
                right: 10px;
                font-size: 11px;
                padding: 8px 12px;
            }
        }

        @media (min-width: 769px) {
            .mobile-date-trigger {
                display: none;
            }
        }

        /* Loading animation */
        .sync-spinner {
            width: 12px;
            height: 12px;
            border: 2px solid #e1e1e1;
            border-top: 2px solid #666;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <h1 class="logo">Meridian</h1>
                <div class="nav-buttons">
                    <button class="nav-btn active" data-screen="top">
                        <svg viewBox="0 0 24 24">
                            <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
                        </svg>
                    </button>
                    <button class="nav-btn" data-screen="list">
                        <svg viewBox="0 0 24 24">
                            <path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/>
                        </svg>
                    </button>
                    <button class="settings-btn" onclick="app.showSettings()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.22,8.95 2.27,9.22 2.46,9.37L4.57,11C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.22,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.03 4.95,18.95L7.44,17.94C7.96,18.34 8.5,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.68 16.04,18.34 16.56,17.94L19.05,18.95C19.27,19.03 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <main class="main-content">
        <div class="container">
            <!-- Top Screen -->
            <div class="screen active" id="top-screen">
                <div class="top-screen">
                    <!-- Calendar Section -->
                    <div class="calendar-section">
                        <div class="calendar-header">
                            <h2 class="calendar-title">Calendar</h2>
                            <div class="calendar-nav">
                                <button class="calendar-nav-btn" id="prev-month">‹</button>
                                <button class="calendar-nav-btn" id="next-month">›</button>
                            </div>
                        </div>
                        <div class="calendar-grid">
                            <div class="calendar-days">
                                <div class="calendar-day-header">SUN</div>
                                <div class="calendar-day-header">MON</div>
                                <div class="calendar-day-header">TUE</div>
                                <div class="calendar-day-header">WED</div>
                                <div class="calendar-day-header">THU</div>
                                <div class="calendar-day-header">FRI</div>
                                <div class="calendar-day-header">SAT</div>
                            </div>
                            <div class="calendar-dates" id="calendar-dates"></div>
                        </div>
                    </div>

                    <!-- Today Section -->
                    <div class="today-section">
                        <div class="today-header">
                            <div class="today-header-top">
                                <h2 class="today-title" id="today-title">9/22(月) Today's Tasks</h2>
                                <div class="copy-all-section" id="copy-all-section">
                                    <button class="copy-all-btn" onclick="app.copyAllTasks()">コピー</button>
                                    <button class="clear-all-btn" onclick="app.clearAllTasks()">一括削除</button>
                                </div>
                                <div class="mobile-date-trigger" id="mobile-date-trigger">
                                    <span id="mobile-current-date">9/22 (Mon)</span>
                                </div>
                            </div>
                        </div>
                        <div class="task-list" id="today-tasks">
                            <!-- Tasks will be populated here -->
                        </div>
                        <div class="add-task">
                            <div class="add-task-form">
                                <input 
                                    type="text" 
                                    class="add-task-input" 
                                    id="new-task-input"
                                    placeholder="新しいタスク"
                                >
                                <button class="add-task-btn" id="add-task-btn">追加</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- List Screen -->
            <div class="screen" id="list-screen">
                <div class="list-screen" id="list-container">
                    <!-- List items will be populated here -->
                </div>
            </div>
        </div>
    </main>

    <!-- Mobile Calendar Modal -->
    <div class="calendar-modal" id="calendar-modal">
        <div class="calendar-modal-content">
            <div class="calendar-modal-header">
                <h3>Calendar</h3>
                <button class="close-modal" id="close-modal">×</button>
            </div>
            <div class="calendar-grid">
                <div class="calendar-nav" style="padding: 20px; display: flex; justify-content: space-between; align-items: center;">
                    <button class="calendar-nav-btn" id="modal-prev-month">‹</button>
                    <span id="modal-calendar-title"></span>
                    <button class="calendar-nav-btn" id="modal-next-month">›</button>
                </div>
                <div style="padding: 0 20px 20px;">
                    <div class="calendar-days">
                        <div class="calendar-day-header">SUN</div>
                        <div class="calendar-day-header">MON</div>
                        <div class="calendar-day-header">TUE</div>
                        <div class="calendar-day-header">WED</div>
                        <div class="calendar-day-header">THU</div>
                        <div class="calendar-day-header">FRI</div>
                        <div class="calendar-day-header">SAT</div>
                    </div>
                    <div class="calendar-dates" id="modal-calendar-dates"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="settings-modal" id="settings-modal">
        <div class="settings-modal-content">
            <div class="settings-header">
                <h3>Sync Settings</h3>
                <button class="close-modal" onclick="app.hideSettings()">×</button>
            </div>
            <div class="settings-form">
                <div class="form-group">
                    <label class="form-label">GitHub Personal Access Token</label>
                    <input 
                        type="password" 
                        class="form-input" 
                        id="github-token"
                        placeholder="ghp_xxxxxxxxxxxxxxxxxxxx"
                    >
                    <div class="form-help">
                        GitHub設定でPersonal Access Tokenを作成し、'gist'スコープを有効にしてください
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Gist ID (Optional)</label>
                    <input 
                        type="text" 
                        class="form-input" 
                        id="gist-id"
                        placeholder="自動で作成されます"
                    >
                    <div class="form-help">
                        既存のGistを使用したい場合はIDを入力してください
                    </div>
                </div>
            </div>
            <div class="settings-actions">
                <button class="btn btn-secondary" onclick="app.hideSettings()">キャンセル</button>
                <button class="btn btn-primary" onclick="app.saveSettings()">保存</button>
            </div>
        </div>
    </div>

    <!-- Sync Status Indicator -->
    <div class="sync-status" id="sync-status">
        <span class="sync-spinner" id="sync-spinner" style="display: none;"></span>
        <span id="sync-text">ローカルモード</span>
    </div>

    <script>
        class LuxuryTodoApp {
            constructor() {
                this.currentDate = new Date();
                this.currentDate.setHours(0, 0, 0, 0);
                this.selectedDate = new Date(this.currentDate);
                this.currentCalendarDate = new Date(this.currentDate);
                this.tasks = {}; // { 'YYYY-MM-DD': [{ id, text, completed }] }
                this.taskIdCounter = 1;
                this.saveTimer = null;
                this.syncStatus = 'local';
                this.expandedItems = new Set(); // Track expanded list items
                this.copiedTasks = []; // Store copied tasks
                
                // GitHub sync settings
                this.githubToken = '';
                this.gistId = '';
                this.syncEnabled = false;
                
                this.init();
            }

            init() {
                this.loadSettings();
                this.loadData();
                this.bindEvents();
                this.renderCalendar();
                this.renderTodayTasks();
                this.renderListScreen();
                this.updateDateDisplay();
                this.startPeriodicSync();
            }

            // Settings Management
            loadSettings() {
                try {
                    const settings = localStorage.getItem('meridianSyncSettings');
                    if (settings) {
                        const parsed = JSON.parse(settings);
                        this.githubToken = parsed.githubToken || '';
                        this.gistId = parsed.gistId || '';
                        this.syncEnabled = !!(this.githubToken);
                        
                        if (this.syncEnabled) {
                            this.updateSyncStatus('syncing', 'GitHub同期有効');
                        } else {
                            this.updateSyncStatus('local', 'ローカルモード');
                        }
                    }
                } catch (error) {
                    console.warn('Could not load sync settings:', error);
                    this.updateSyncStatus('local', 'ローカルモード');
                }
            }

            saveSettings() {
                const token = document.getElementById('github-token').value.trim();
                const gistId = document.getElementById('gist-id').value.trim();
                
                if (!token) {
                    alert('GitHub Personal Access Tokenを入力してください');
                    return;
                }
                
                this.githubToken = token;
                this.gistId = gistId;
                this.syncEnabled = true;
                
                const settings = {
                    githubToken: this.githubToken,
                    gistId: this.gistId
                };
                
                localStorage.setItem('meridianSyncSettings', JSON.stringify(settings));
                this.hideSettings();
                
                // Initial sync
                this.syncToGitHub();
            }

            showSettings() {
                document.getElementById('github-token').value = this.githubToken;
                document.getElementById('gist-id').value = this.gistId;
                document.getElementById('settings-modal').classList.add('active');
            }

            hideSettings() {
                document.getElementById('settings-modal').classList.remove('active');
            }

            // Data Management & Sync
            async loadData() {
                try {
                    // Try to load from GitHub first if sync is enabled
                    if (this.syncEnabled) {
                        await this.loadFromGitHub();
                    } else {
                        // Load from localStorage
                        const savedData = localStorage.getItem('meridianTodoData');
                        if (savedData) {
                            const data = JSON.parse(savedData);
                            this.tasks = data.tasks || {};
                            this.taskIdCounter = data.taskIdCounter || 1;
                            this.updateSyncStatus('saved', 'データを読み込みました');
                        }
                    }
                } catch (error) {
                    console.warn('Could not load data:', error);
                    this.updateSyncStatus('error', '読み込みに失敗しました');
                }
            }

            async loadFromGitHub() {
                if (!this.syncEnabled) return;

                try {
                    this.updateSyncStatus('syncing', 'GitHubから同期中...');
                    
                    let url;
                    if (this.gistId) {
                        url = `https://api.github.com/gists/${this.gistId}`;
                    } else {
                        // Find existing gist
                        const gistsUrl = 'https://api.github.com/gists';
                        const gistsResponse = await fetch(gistsUrl, {
                            headers: {
                                'Authorization': `Bearer ${this.githubToken}`,
                                'Accept': 'application/vnd.github+json'
                            }
                        });
                        
                        if (gistsResponse.ok) {
                            const gists = await gistsResponse.json();
                            const meridianGist = gists.find(g => 
                                g.files['meridian-todo-data.json'] || 
                                g.description === 'Meridian Todo App Data'
                            );
                            
                            if (meridianGist) {
                                this.gistId = meridianGist.id;
                                url = `https://api.github.com/gists/${this.gistId}`;
                            }
                        }
                    }

                    if (url) {
                        const response = await fetch(url, {
                            headers: {
                                'Authorization': `Bearer ${this.githubToken}`,
                                'Accept': 'application/vnd.github+json'
                            }
                        });

                        if (response.ok) {
                            const gist = await response.json();
                            const dataFile = gist.files['meridian-todo-data.json'];
                            if (dataFile) {
                                const data = JSON.parse(dataFile.content);
                                this.tasks = data.tasks || {};
                                this.taskIdCounter = data.taskIdCounter || 1;
                                this.updateSyncStatus('saved', 'GitHubから同期完了');
                                return;
                            }
                        }
                    }
                    
                    // If no gist found, load from localStorage
                    const savedData = localStorage.getItem('meridianTodoData');
                    if (savedData) {
                        const data = JSON.parse(savedData);
                        this.tasks = data.tasks || {};
                        this.taskIdCounter = data.taskIdCounter || 1;
                    }
                    
                } catch (error) {
                    console.error('GitHub sync error:', error);
                    this.updateSyncStatus('error', 'GitHub同期エラー');
                    
                    // Fallback to localStorage
                    const savedData = localStorage.getItem('meridianTodoData');
                    if (savedData) {
                        const data = JSON.parse(savedData);
                        this.tasks = data.tasks || {};
                        this.taskIdCounter = data.taskIdCounter || 1;
                    }
                }
            }

            async syncToGitHub() {
                if (!this.syncEnabled) return;

                try {
                    this.updateSyncStatus('syncing', 'GitHubに同期中...');
                    
                    const data = {
                        tasks: this.tasks,
                        taskIdCounter: this.taskIdCounter,
                        lastSync: new Date().toISOString(),
                        version: '1.0'
                    };

                    const gistData = {
                        description: 'Meridian Todo App Data',
                        public: false,
                        files: {
                            'meridian-todo-data.json': {
                                content: JSON.stringify(data, null, 2)
                            }
                        }
                    };

                    let url = 'https://api.github.com/gists';
                    let method = 'POST';
                    
                    if (this.gistId) {
                        url = `https://api.github.com/gists/${this.gistId}`;
                        method = 'PATCH';
                    }

                    const response = await fetch(url, {
                        method: method,
                        headers: {
                            'Authorization': `Bearer ${this.githubToken}`,
                            'Accept': 'application/vnd.github+json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(gistData)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        if (!this.gistId) {
                            this.gistId = result.id;
                            // Save the gist ID
                            const settings = {
                                githubToken: this.githubToken,
                                gistId: this.gistId
                            };
                            localStorage.setItem('meridianSyncSettings', JSON.stringify(settings));
                        }
                        
                        this.updateSyncStatus('saved', 'GitHubに同期完了');
                        setTimeout(() => {
                            if (this.syncStatus === 'saved') {
                                this.updateSyncStatus('syncing', 'GitHub同期有効');
                            }
                        }, 3000);
                    } else {
                        throw new Error(`GitHub API error: ${response.status}`);
                    }
                    
                } catch (error) {
                    console.error('GitHub sync error:', error);
                    this.updateSyncStatus('error', 'GitHub同期エラー');
                    setTimeout(() => {
                        if (this.syncStatus === 'error') {
                            this.updateSyncStatus('syncing', 'GitHub同期有効');
                        }
                    }, 5000);
                }
            }

            saveData() {
                try {
                    this.updateSyncStatus('saving', '保存中...');
                    
                    const data = {
                        tasks: this.tasks,
                        taskIdCounter: this.taskIdCounter,
                        lastSync: new Date().toISOString(),
                        version: '1.0'
                    };
                    
                    // Always save to localStorage as backup
                    localStorage.setItem('meridianTodoData', JSON.stringify(data));
                    
                    // Sync to GitHub if enabled
                    if (this.syncEnabled) {
                        this.syncToGitHub();
                    } else {
                        // Simulate sync delay for user feedback
                        setTimeout(() => {
                            this.updateSyncStatus('saved', '保存しました');
                            setTimeout(() => {
                                this.updateSyncStatus('local', 'ローカルモード');
                            }, 2000);
                        }, 300);
                    }
                    
                } catch (error) {
                    console.error('Could not save data:', error);
                    this.updateSyncStatus('error', '保存に失敗しました');
                    
                    // Fallback to cookie if localStorage fails
                    try {
                        const fallbackData = JSON.stringify(data);
                        if (fallbackData.length < 4000) { // Cookie size limit
                            document.cookie = `meridianTodoFallback=${encodeURIComponent(fallbackData)};expires=${new Date(Date.now() + 365*24*60*60*1000).toUTCString()};path=/`;
                        }
                    } catch (fallbackError) {
                        console.error('Fallback save also failed:', fallbackError);
                    }
                }
            }

            updateSyncStatus(status, text) {
                this.syncStatus = status;
                const statusEl = document.getElementById('sync-status');
                const spinnerEl = document.getElementById('sync-spinner');
                const textEl = document.getElementById('sync-text');
                
                statusEl.className = `sync-status ${status}`;
                textEl.textContent = text;
                
                if (status === 'syncing' || status === 'saving') {
                    spinnerEl.style.display = 'block';
                } else {
                    spinnerEl.style.display = 'none';
                }
            }

            startPeriodicSync() {
                // Auto-sync every 2 minutes if GitHub sync is enabled
                setInterval(() => {
                    if (this.syncStatus !== 'syncing' && this.syncEnabled) {
                        this.syncToGitHub();
                    } else if (!this.syncEnabled && this.syncStatus !== 'saving') {
                        // Auto-save locally every 30 seconds
                        this.saveData();
                    }
                }, this.syncEnabled ? 120000 : 30000);
            }

            triggerSave() {
                clearTimeout(this.saveTimer);
                this.saveTimer = setTimeout(() => {
                    this.saveData();
                }, 1000); // Debounce saves
            }

            bindEvents() {
                // Navigation - 修正：e.currentTargetを使用
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        // e.currentTargetでボタン要素自体を取得
                        const targetBtn = e.currentTarget;
                        const screen = targetBtn.dataset.screen;
                        
                        // screenが有効な値かチェック
                        if (screen) {
                            this.switchScreen(screen);
                        }
                    });
                });

                // Calendar navigation
                document.getElementById('prev-month').addEventListener('click', () => {
                    this.currentCalendarDate.setMonth(this.currentCalendarDate.getMonth() - 1);
                    this.renderCalendar();
                });

                document.getElementById('next-month').addEventListener('click', () => {
                    this.currentCalendarDate.setMonth(this.currentCalendarDate.getMonth() + 1);
                    this.renderCalendar();
                });

                // Modal calendar navigation
                document.getElementById('modal-prev-month').addEventListener('click', () => {
                    this.currentCalendarDate.setMonth(this.currentCalendarDate.getMonth() - 1);
                    this.renderModalCalendar();
                });

                document.getElementById('modal-next-month').addEventListener('click', () => {
                    this.currentCalendarDate.setMonth(this.currentCalendarDate.getMonth() + 1);
                    this.renderModalCalendar();
                });

                // Add task
                document.getElementById('add-task-btn').addEventListener('click', () => {
                    this.addTask();
                });

                document.getElementById('new-task-input').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.addTask();
                    }
                });

                // Mobile calendar modal
                document.getElementById('mobile-date-trigger').addEventListener('click', () => {
                    this.showCalendarModal();
                });

                document.getElementById('close-modal').addEventListener('click', () => {
                    this.hideCalendarModal();
                });

                document.getElementById('calendar-modal').addEventListener('click', (e) => {
                    if (e.target.id === 'calendar-modal') {
                        this.hideCalendarModal();
                    }
                });

                // Settings modal
                document.getElementById('settings-modal').addEventListener('click', (e) => {
                    if (e.target.id === 'settings-modal') {
                        this.hideSettings();
                    }
                });

                // Auto-save before page unload
                window.addEventListener('beforeunload', () => {
                    this.saveData();
                });
            }

            switchScreen(screen) {
                // screenパラメータの妥当性チェックを追加
                if (!screen || (screen !== 'top' && screen !== 'list')) {
                    console.warn('Invalid screen parameter:', screen);
                    return;
                }

                document.querySelectorAll('.nav-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // より安全な要素選択
                const targetBtn = document.querySelector(`[data-screen="${screen}"]`);
                if (targetBtn) {
                    targetBtn.classList.add('active');
                }

                document.querySelectorAll('.screen').forEach(s => {
                    s.classList.remove('active');
                });
                
                const targetScreen = document.getElementById(`${screen}-screen`);
                if (targetScreen) {
                    targetScreen.classList.add('active');
                }

                if (screen === 'list') {
                    this.renderListScreen();
                }
            }

            formatDate(date) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }

            formatDisplayDate(date) {
                const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                const month = date.getMonth() + 1;
                const day = date.getDate();
                const dayOfWeek = days[date.getDay()];
                return `${month}/${day} (${dayOfWeek})`;
            }

            formatDisplayDateForList(date) {
                const days = ['日', '月', '火', '水', '木', '金', '土'];
                const month = date.getMonth() + 1;
                const day = date.getDate();
                const dayOfWeek = days[date.getDay()];
                return `${month}/${day}(${dayOfWeek})`;
            }

            updateDateDisplay() {
                const displayDate = this.formatDisplayDate(this.selectedDate);
                const displayDateJapanese = this.formatDisplayDateForList(this.selectedDate);
                document.getElementById('today-title').textContent = `${displayDateJapanese} Today's Tasks`;
                document.getElementById('mobile-current-date').textContent = displayDate;
            }

            renderCalendar(modal = false) {
                const container = modal ? 'modal-calendar-dates' : 'calendar-dates';
                const titleContainer = modal ? 'modal-calendar-title' : null;
                
                const year = this.currentCalendarDate.getFullYear();
                const month = this.currentCalendarDate.getMonth();
                
                if (titleContainer) {
                    const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
                                      'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                    document.getElementById(titleContainer).textContent = `${monthNames[month]} ${year}`;
                }

                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const firstDayOfWeek = firstDay.getDay();
                const daysInMonth = lastDay.getDate();

                let html = '';

                // Previous month's trailing days
                const prevMonth = new Date(year, month - 1, 0);
                for (let i = firstDayOfWeek - 1; i >= 0; i--) {
                    const day = prevMonth.getDate() - i;
                    html += `<div class="calendar-date other-month">${day}</div>`;
                }

                // Current month's days
                for (let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(year, month, day);
                    const dateStr = this.formatDate(date);
                    const isToday = this.formatDate(date) === this.formatDate(this.currentDate);
                    const isCompleted = this.isDateCompleted(dateStr);
                    
                    let classes = 'calendar-date';
                    if (isToday) classes += ' today';
                    if (isCompleted) classes += ' completed';

                    html += `<div class="${classes}" data-date="${dateStr}" onclick="app.selectDate('${dateStr}')">${day}</div>`;
                }

                // Next month's leading days
                const totalCells = Math.ceil((firstDayOfWeek + daysInMonth) / 7) * 7;
                const remainingCells = totalCells - (firstDayOfWeek + daysInMonth);
                for (let day = 1; day <= remainingCells; day++) {
                    html += `<div class="calendar-date other-month">${day}</div>`;
                }

                document.getElementById(container).innerHTML = html;
            }

            renderModalCalendar() {
                this.renderCalendar(true);
            }

            showCalendarModal() {
                document.getElementById('calendar-modal').classList.add('active');
                this.renderModalCalendar();
            }

            hideCalendarModal() {
                document.getElementById('calendar-modal').classList.remove('active');
            }

            selectDate(dateStr) {
                this.selectedDate = new Date(dateStr + 'T00:00:00');
                this.updateDateDisplay();
                this.renderTodayTasks();
                this.hideCalendarModal();
                
                // Switch to top screen if on list screen
                if (document.getElementById('list-screen').classList.contains('active')) {
                    this.switchScreen('top');
                }
            }

            isDateCompleted(dateStr) {
                const tasks = this.tasks[dateStr] || [];
                return tasks.length > 0 && tasks.every(task => task.completed);
            }

            addTask() {
                const input = document.getElementById('new-task-input');
                const text = input.value.trim();
                
                if (!text) return;

                const dateStr = this.formatDate(this.selectedDate);
                if (!this.tasks[dateStr]) {
                    this.tasks[dateStr] = [];
                }

                this.tasks[dateStr].push({
                    id: this.taskIdCounter++,
                    text: text,
                    completed: false
                });

                input.value = '';
                this.renderTodayTasks();
                this.renderCalendar();
                this.renderListScreen();
                this.triggerSave();
            }

            toggleTask(dateStr, taskId) {
                const tasks = this.tasks[dateStr] || [];
                const task = tasks.find(t => t.id === taskId);
                if (task) {
                    task.completed = !task.completed;
                    this.renderTodayTasks();
                    this.renderCalendar();
                    this.renderListScreen();
                    this.triggerSave();
                }
            }

            deleteTask(dateStr, taskId) {
                if (this.tasks[dateStr]) {
                    this.tasks[dateStr] = this.tasks[dateStr].filter(t => t.id !== taskId);
                    if (this.tasks[dateStr].length === 0) {
                        delete this.tasks[dateStr];
                    }
                    this.renderTodayTasks();
                    this.renderCalendar();
                    this.renderListScreen();
                    this.triggerSave();
                }
            }

            editTask(dateStr, taskId, newText) {
                const tasks = this.tasks[dateStr] || [];
                const task = tasks.find(t => t.id === taskId);
                if (task && newText.trim()) {
                    task.text = newText.trim();
                    this.renderTodayTasks();
                    this.renderListScreen();
                    this.triggerSave();
                }
            }

            copyTaskToNextDay(dateStr, taskId) {
                const tasks = this.tasks[dateStr] || [];
                const task = tasks.find(t => t.id === taskId);
                if (!task) return;

                const currentDate = new Date(dateStr + 'T00:00:00');
                const nextDate = new Date(currentDate);
                nextDate.setDate(nextDate.getDate() + 1);
                const nextDateStr = this.formatDate(nextDate);

                if (!this.tasks[nextDateStr]) {
                    this.tasks[nextDateStr] = [];
                }

                this.tasks[nextDateStr].push({
                    id: this.taskIdCounter++,
                    text: task.text,
                    completed: false
                });

                this.renderTodayTasks();
                this.renderListScreen();
                this.triggerSave();
            }

            renderTodayTasks() {
                const dateStr = this.formatDate(this.selectedDate);
                const tasks = this.tasks[dateStr] || [];
                const container = document.getElementById('today-tasks');
                const copyAllSection = document.getElementById('copy-all-section');

                // Show/hide copy all section based on whether there are tasks
                if (tasks.length > 0) {
                    copyAllSection.style.display = 'flex';
                } else {
                    copyAllSection.style.display = 'none';
                }

                if (tasks.length === 0) {
                    container.innerHTML = '<div style="text-align: center; color: #666; padding: 40px; font-size: 14px;">タスクがありません</div>';
                    return;
                }

                const html = tasks.map(task => `
                    <div class="task-item">
                        <div class="task-checkbox ${task.completed ? 'checked' : ''}" 
                             onclick="app.toggleTask('${dateStr}', ${task.id})">
                            ${task.completed ? '✓' : ''}
                        </div>
                        <div class="task-text ${task.completed ? 'completed' : ''}" 
                             onclick="app.startEditTask(this, '${dateStr}', ${task.id})"
                             data-original="${task.text}">${task.text}</div>
                        <div class="task-actions">
                            <button class="delete-btn" onclick="app.deleteTask('${dateStr}', ${task.id})">削除</button>
                        </div>
                    </div>
                `).join('');

                container.innerHTML = html;
            }

            startEditTask(element, dateStr, taskId) {
                if (element.classList.contains('editing')) return;

                const originalText = element.dataset.original;
                element.classList.add('editing');
                element.contentEditable = true;
                element.focus();

                const finishEdit = () => {
                    element.classList.remove('editing');
                    element.contentEditable = false;
                    const newText = element.textContent.trim();
                    
                    if (newText && newText !== originalText) {
                        this.editTask(dateStr, taskId, newText);
                    } else {
                        element.textContent = originalText;
                    }
                };

                element.addEventListener('blur', finishEdit, { once: true });
                element.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        element.blur();
                    }
                }, { once: true });
            }

            renderListScreen() {
                const container = document.getElementById('list-container');
                const today = new Date(this.currentDate);
                
                let html = '';
                
                // Generate dates for the next year
                for (let i = 0; i < 365; i++) {
                    const date = new Date(today);
                    date.setDate(date.getDate() + i);
                    const dateStr = this.formatDate(date);
                    const displayDate = this.formatDisplayDateForList(date);
                    const tasks = this.tasks[dateStr] || [];
                    
                    // Add a label for today, tomorrow, etc.
                    let label = '';
                    if (i === 0) label = ' のタスク';
                    else if (i === 1) label = ' のタスク';
                    else label = ' のタスク';
                    
                    const isExpanded = this.expandedItems.has(dateStr);
                    
                    html += `
                        <div class="list-item ${isExpanded ? 'expanded' : ''}" data-date="${dateStr}">
                            <div class="list-item-header" onclick="app.toggleListItem(this)">
                                <div class="list-item-title">${displayDate}${label}</div>
                                <div class="list-item-indicator"></div>
                            </div>
                            <div class="list-item-content">
                                <div class="task-list">
                                    ${tasks.length === 0 ? 
                                        '<div style="text-align: center; color: #666; padding: 20px; font-size: 14px;">タスクがありません</div>' :
                                        tasks.map(task => `
                                            <div class="task-item">
                                                <div class="task-checkbox ${task.completed ? 'checked' : ''}" 
                                                     onclick="app.toggleTask('${dateStr}', ${task.id})">
                                                    ${task.completed ? '✓' : ''}
                                                </div>
                                                <div class="task-text ${task.completed ? 'completed' : ''}" 
                                                     onclick="app.startEditTask(this, '${dateStr}', ${task.id})"
                                                     data-original="${task.text}">${task.text}</div>
                                                <div class="task-actions">
                                                    <button class="delete-btn" onclick="app.deleteTask('${dateStr}', ${task.id})">Delete</button>
                                                </div>
                                            </div>
                                        `).join('')
                                    }
                                </div>
                                <div class="add-task">
                                    <div class="add-task-form">
                                        <input type="text" class="add-task-input" placeholder="新しいタスク" 
                                               onkeypress="if(event.key==='Enter') app.addTaskToDate('${dateStr}', this)">
                                        <button class="add-task-btn" onclick="app.addTaskToDate('${dateStr}', this.previousElementSibling)">追加</button>
                                        <button class="paste-btn" onclick="app.pasteTasksToDate('${dateStr}')" 
                                                id="paste-btn-${dateStr}" 
                                                ${this.copiedTasks.length === 0 ? 'disabled' : ''}>貼り付け</button>
                                        ${tasks.length > 0 ? `<button class="clear-all-btn" onclick="app.clearAllTasksForDate('${dateStr}')">一括削除</button>` : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                container.innerHTML = html;
            }

            toggleListItem(header) {
                const listItem = header.parentElement;
                const dateStr = listItem.dataset.date;
                
                if (this.expandedItems.has(dateStr)) {
                    this.expandedItems.delete(dateStr);
                    listItem.classList.remove('expanded');
                } else {
                    this.expandedItems.add(dateStr);
                    listItem.classList.add('expanded');
                }
            }

            copyAllTasks() {
                const currentDateStr = this.formatDate(this.selectedDate);
                const currentTasks = this.tasks[currentDateStr] || [];
                
                if (currentTasks.length === 0) {
                    this.showTemporaryMessage('コピーするタスクがありません');
                    return;
                }

                // Copy tasks to clipboard
                this.copiedTasks = currentTasks.map(task => ({
                    text: task.text,
                    completed: false // Always copy as uncompleted
                }));

                this.showTemporaryMessage(`${this.copiedTasks.length}個のタスクをコピーしました`);
                this.updatePasteButtons();
            }

            clearAllTasks() {
                const currentDateStr = this.formatDate(this.selectedDate);
                const currentTasks = this.tasks[currentDateStr] || [];
                
                if (currentTasks.length === 0) {
                    this.showTemporaryMessage('削除するタスクがありません');
                    return;
                }

                // Confirm before deleting
                const confirmMessage = `${currentTasks.length}個のタスクを削除しますか？この操作は元に戻せません。`;
                if (confirm(confirmMessage)) {
                    const taskCount = currentTasks.length;
                    delete this.tasks[currentDateStr];
                    
                    this.showTemporaryMessage(`${taskCount}個のタスクを削除しました`);
                    
                    this.renderTodayTasks();
                    this.renderCalendar();
                    this.renderListScreen();
                    this.triggerSave();
                }
            }

            clearAllTasksForDate(dateStr) {
                const tasks = this.tasks[dateStr] || [];
                
                if (tasks.length === 0) {
                    this.showTemporaryMessage('削除するタスクがありません');
                    return;
                }

                const targetDate = new Date(dateStr + 'T00:00:00');
                const displayDate = this.formatDisplayDateForList(targetDate);
                const confirmMessage = `${displayDate}の${tasks.length}個のタスクを削除しますか？この操作は元に戻せません。`;
                
                if (confirm(confirmMessage)) {
                    const taskCount = tasks.length;
                    delete this.tasks[dateStr];
                    
                    this.showTemporaryMessage(`${displayDate}の${taskCount}個のタスクを削除しました`);
                    
                    this.renderListScreen();
                    this.renderCalendar();
                    if (dateStr === this.formatDate(this.selectedDate)) {
                        this.renderTodayTasks();
                    }
                    this.triggerSave();
                }
            }

            pasteTasksToDate(dateStr) {
                if (this.copiedTasks.length === 0) {
                    this.showTemporaryMessage('コピーされたタスクがありません');
                    return;
                }

                if (!this.tasks[dateStr]) {
                    this.tasks[dateStr] = [];
                }

                // Paste all copied tasks
                this.copiedTasks.forEach(task => {
                    this.tasks[dateStr].push({
                        id: this.taskIdCounter++,
                        text: task.text,
                        completed: false
                    });
                });

                const targetDate = new Date(dateStr + 'T00:00:00');
                const targetDisplayDate = this.formatDisplayDateForList(targetDate);
                this.showTemporaryMessage(`${this.copiedTasks.length}個のタスクを${targetDisplayDate}に貼り付けました`);

                this.renderListScreen();
                this.renderCalendar();
                if (dateStr === this.formatDate(this.selectedDate)) {
                    this.renderTodayTasks();
                }
                this.triggerSave();
            }

            updatePasteButtons() {
                // Update all paste buttons
                const pasteButtons = document.querySelectorAll('[id^="paste-btn-"]');
                pasteButtons.forEach(btn => {
                    btn.disabled = this.copiedTasks.length === 0;
                });
            }

            showTemporaryMessage(message) {
                const messageEl = document.createElement('div');
                messageEl.style.cssText = `
                    position: fixed;
                    top: 80px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: #000;
                    color: white;
                    padding: 12px 20px;
                    border-radius: 50px;
                    font-size: 14px;
                    z-index: 2000;
                    opacity: 0;
                    transition: opacity 0.3s;
                    text-align: center;
                    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                `;
                messageEl.textContent = message;
                document.body.appendChild(messageEl);

                // Fade in
                setTimeout(() => {
                    messageEl.style.opacity = '1';
                }, 10);

                // Fade out and remove
                setTimeout(() => {
                    messageEl.style.opacity = '0';
                    setTimeout(() => {
                        document.body.removeChild(messageEl);
                    }, 300);
                }, 2000);
            }

            addTaskToDate(dateStr, inputElement) {
                const text = inputElement.value.trim();
                if (!text) return;

                if (!this.tasks[dateStr]) {
                    this.tasks[dateStr] = [];
                }

                this.tasks[dateStr].push({
                    id: this.taskIdCounter++,
                    text: text,
                    completed: false
                });

                inputElement.value = '';
                this.renderListScreen();
                this.renderCalendar();
                
                // Update today tasks if it's the selected date
                if (dateStr === this.formatDate(this.selectedDate)) {
                    this.renderTodayTasks();
                }
                
                this.triggerSave();
            }
        }

        // Initialize the app
        const app = new LuxuryTodoApp();

        // Make functions globally accessible for onclick handlers
        window.app = app;
    </script>
</body>
</html>